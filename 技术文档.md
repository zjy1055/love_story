# 恋爱故事记录应用 - 技术文档

## 1. 项目概述

### 1.1 项目背景
恋爱故事记录应用是一款专为情侣设计的个人化应用，旨在帮助用户记录恋爱过程中的重要事件、照片和回忆，创建专属的数字时光机。

### 1.2 主要功能
- **事件记录**：记录恋爱中的重要事件、纪念日和未来计划
- **照片管理**：上传、分类、标记和查看照片，支持相册功能
- **配置管理**：个性化设置、纪念日设置和爱情宣言等
- **数据备份与恢复**：自动和手动备份，确保数据安全

### 1.3 应用场景
- 记录恋爱过程中的重要时刻
- 整理和管理两人的照片集
- 追踪纪念日和特殊日期
- 备份珍贵回忆数据

## 2. 系统架构与技术栈

### 2.1 整体架构
本项目采用经典的前后端分离架构，具体架构如下：

- **前端**：纯HTML/CSS/JavaScript，无框架依赖
- **后端**：Python Flask框架
- **数据库**：SQLite（轻量级嵌入式数据库）
- **文件存储**：本地文件系统存储用户上传的照片

### 2.2 技术栈详情

#### 后端技术
- **Python**：主要开发语言
- **Flask**：Web框架，用于构建RESTful API
- **SQLAlchemy**：ORM框架，用于数据库操作
- **Flask-CORS**：处理跨域请求
- **Pillow**：图像处理库，用于生成缩略图

#### 前端技术
- **HTML5**：页面结构
- **CSS3**：样式设计
- **JavaScript**：交互逻辑和API调用
- **Font Awesome**：图标库

#### 部署工具
- **PyInstaller**：用于打包应用为可执行文件

## 3. 目录结构

```
love_story_app/
├── main.py                # 应用程序入口点
├── requirements.txt       # Python依赖包列表
├── backend/               # 后端代码目录
│   ├── __init__.py
│   ├── app.py             # Flask应用创建和配置
│   ├── models.py          # 数据库模型定义
│   ├── routes.py          # API路由定义
│   └── utils.py           # 工具函数集
├── frontend/              # 前端代码目录
│   ├── index.html         # 主页面
│   ├── styles.css         # 样式文件
│   └── scripts.js         # JavaScript交互逻辑
└── data/                  # 数据目录（运行时创建）
    ├── app.db             # SQLite数据库文件
    ├── uploads/           # 上传的照片存储目录
    └── backups/           # 备份文件存储目录
```

## 4. 后端核心模块

### 4.1 Flask应用配置 (app.py)

Flask应用通过工厂模式创建，主要功能包括：

- **数据目录配置**：支持开发环境和打包环境下的数据目录处理
- **数据库初始化**：配置SQLAlchemy连接和初始化
- **CORS设置**：配置跨域资源共享，允许前端访问API
- **路由注册**：注册所有API路由
- **服务配置**：配置缩略图生成服务、文件上传服务等
- **异常处理**：全局异常捕获和处理机制

核心代码结构：

```python
def create_app(data_dir):
    # 创建Flask应用实例
    app = Flask(__name__, static_folder='../frontend', static_url_path='/')
    
    # 配置数据库连接
    app.config['SQLALCHEMY_DATABASE_URI'] = f'sqlite:///{os.path.join(data_dir, "app.db")}'
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    
    # 初始化数据库
    db.init_app(app)
    
    # 配置CORS
    CORS(app)
    
    # 注册路由
    setup_routes(app, data_dir)
    
    # 配置文件上传服务
    # ...
    
    # 返回配置完成的应用
    return app
```

### 4.2 数据库模型 (models.py)

定义了应用所需的核心数据模型：

- **Event**：事件记录模型
- **Album**：相册模型
- **Photo**：照片模型
- **Tag**：标签模型
- **Config**：配置信息模型

模型间关系：
- 照片可以属于多个相册
- 照片可以关联多个事件
- 照片可以有多个标签（多对多关系）

核心模型示例：

```python
class Photo(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    filename = db.Column(db.String(255), nullable=False)
    original_name = db.Column(db.String(255))
    description = db.Column(db.Text)
    date = db.Column(db.Date)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # 外键关系
    album_id = db.Column(db.Integer, db.ForeignKey('album.id'))
    event_id = db.Column(db.Integer, db.ForeignKey('event.id'))
    
    # 多对多关系
    tags = db.relationship('Tag', secondary=photo_tags, backref=db.backref('photos', lazy='dynamic'))
```

### 4.3 API路由 (routes.py)

实现了完整的RESTful API，主要包括：

- **事件管理API**：创建、获取、更新和删除事件
- **照片管理API**：上传、获取、搜索和删除照片，支持批量操作
- **相册管理API**：创建和管理相册
- **标签管理API**：标签的创建和管理
- **配置管理API**：应用配置的读取和保存

核心API示例（照片上传）：

```python
@app.route('/api/photos', methods=['POST'])
def upload_photo():
    # 检查文件是否存在
    if 'file' not in request.files:
        return jsonify({'error': '未找到文件'}), 400
    
    file = request.files['file']
    
    # 验证文件类型
    if not allowed_file(file.filename):
        return jsonify({'error': '不支持的文件类型'}), 400
    
    # 处理照片上传逻辑
    # ...
    
    # 创建数据库记录
    # ...
    
    return jsonify({'message': '上传成功', 'url': photo_url}), 201
```

### 4.4 工具函数 (utils.py)

提供了一系列辅助功能，包括：

- **文件管理**：目录创建、文件验证、唯一文件名生成
- **图像处理**：照片处理、缩略图生成
- **备份恢复**：数据库备份与恢复功能
- **搜索功能**：高级照片搜索功能
- **辅助功能**：URL生成、路径处理等

## 5. 数据模型与数据库设计

### 5.1 数据库表结构

#### events表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|-----|------|
| id | INTEGER | PRIMARY KEY | 事件ID |
| title | VARCHAR(255) | NOT NULL | 事件标题 |
| description | TEXT | | 事件描述 |
| date | DATE | NOT NULL | 事件日期 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

#### albums表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|-----|------|
| id | INTEGER | PRIMARY KEY | 相册ID |
| name | VARCHAR(255) | NOT NULL | 相册名称 |
| description | TEXT | | 相册描述 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### photos表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|-----|------|
| id | INTEGER | PRIMARY KEY | 照片ID |
| filename | VARCHAR(255) | NOT NULL | 文件名 |
| original_name | VARCHAR(255) | | 原始文件名 |
| description | TEXT | | 照片描述 |
| date | DATE | | 拍摄日期 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| album_id | INTEGER | FOREIGN KEY | 所属相册ID |
| event_id | INTEGER | FOREIGN KEY | 关联事件ID |

#### tags表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|-----|------|
| id | INTEGER | PRIMARY KEY | 标签ID |
| name | VARCHAR(100) | UNIQUE NOT NULL | 标签名称 |

#### photo_tags表 (关联表)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|-----|------|
| photo_id | INTEGER | FOREIGN KEY | 照片ID |
| tag_id | INTEGER | FOREIGN KEY | 标签ID |
| PRIMARY KEY | | (photo_id, tag_id) | 复合主键 |

#### configs表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|-----|------|
| id | INTEGER | PRIMARY KEY | 配置ID |
| key | VARCHAR(100) | UNIQUE NOT NULL | 配置键 |
| value | TEXT | | 配置值 |

### 5.2 数据关系图

事件(Event) 1 ── N 照片(Photo) N ── N 标签(Tag)
相册(Album) 1 ── N 照片(Photo)

## 6. 文件上传与存储机制

### 6.1 文件存储架构

应用采用本地文件系统存储上传的照片，存储结构如下：

```
data/
├── uploads/           # 上传文件根目录
│   ├── original/      # 原始照片
│   └── thumbnails/    # 生成的缩略图
└── app.db             # 数据库文件
```

### 6.2 上传流程

1. **文件验证**：检查文件类型是否为支持的图片格式
2. **路径准备**：确保上传目录存在
3. **文件处理**：
   - 生成唯一文件名（避免覆盖）
   - 保存原始文件
   - 生成缩略图
4. **数据库记录**：创建照片记录，关联相关信息
5. **错误处理**：事务管理，出错时回滚操作

### 6.3 文件安全措施

- **文件类型验证**：限制仅允许图片格式上传
- **文件名处理**：使用UUID生成唯一文件名，避免路径遍历攻击
- **文件大小限制**：通过Flask配置限制上传文件大小
- **目录隔离**：上传文件存储在独立目录，与代码分离

## 7. 前端实现与用户界面

### 7.1 页面结构

应用采用单页应用(SPA)模式，主要包含以下页面：

- **首页**：展示轮播图、纪念日倒计时、价值观、最近事件和精选照片
- **事件记录页面**：事件列表、搜索筛选、事件创建和编辑
- **照片管理页面**：照片网格、相册管理、上传和搜索功能
- **系统设置页面**：纪念日设置、个性化配置、数据备份与恢复

### 7.2 交互设计

- **导航系统**：顶部导航栏 + 移动端汉堡菜单
- **模态框**：用于事件编辑、照片上传、相册创建等操作
- **通知系统**：操作反馈和错误提示
- **轮播图**：首页图片轮播展示
- **照片查看器**：点击照片打开大图查看器

### 7.3 API交互

前端通过Fetch API与后端进行通信，主要交互包括：

- 获取数据（GET请求）：加载事件、照片、配置等
- 创建/更新数据（POST/PUT请求）：保存事件、上传照片、更新设置等
- 删除数据（DELETE请求）：删除事件、照片等

## 8. 部署与配置方案

### 8.1 开发环境配置

1. **安装依赖**：
```bash
pip install -r requirements.txt
```

2. **运行应用**：
```bash
python main.py
```

### 8.2 打包部署

项目使用PyInstaller进行打包，支持Windows平台：

1. **打包命令**：
```bash
pyinstaller --onefile --add-data "frontend;frontend" main.py
```

2. **运行时数据处理**：
   - 开发环境：数据存储在项目根目录的data文件夹
   - 打包环境：数据存储在用户AppData目录下的LoveStory文件夹

### 8.3 数据备份机制

- **自动备份**：系统支持自动创建数据库备份
- **手动备份**：用户可随时手动备份数据
- **备份管理**：自动清理旧备份，最多保留100个备份文件

## 9. 安全风险与优化建议

### 9.1 安全风险

1. **文件上传安全**：
   - 虽然有文件类型验证，但仍需加强内容验证，防止恶意文件上传
   - 建议增加文件内容检测，确保是真正的图片文件

2. **SQL注入防护**：
   - 使用ORM可减轻风险，但需要确保所有查询都通过参数化方式执行
   - 避免在代码中使用原生SQL拼接

3. **用户认证缺失**：
   - 当前应用没有用户认证机制，所有数据对本地用户开放
   - 建议添加基本的访问控制机制，特别是在未来支持多用户时

4. **CORS配置过于宽松**：
   - 当前CORS配置允许所有域名访问
   - 建议限制为特定域名或仅允许本地访问

5. **敏感信息保护**：
   - 数据库文件和上传文件需要适当的权限保护
   - 确保备份文件不包含敏感信息或进行加密存储

### 9.2 性能优化建议

1. **数据库优化**：
   - 添加适当的索引，特别是常用查询字段
   - 考虑分页加载大量数据，避免一次性加载所有内容

2. **图片处理优化**：
   - 实现渐进式加载和延迟加载
   - 根据设备屏幕大小提供不同尺寸的图片

3. **前端性能优化**：
   - 优化JavaScript执行效率，减少DOM操作
   - 实现图片预加载和缓存机制

4. **错误处理增强**：
   - 添加更详细的日志记录
   - 实现更友好的错误提示和恢复机制

5. **功能扩展建议**：
   - 添加数据导出功能，支持导出为PDF或其他格式
   - 实现图片智能分类和人脸识别功能
   - 添加多用户支持和云同步功能

## 10. 总结与展望

恋爱故事记录应用是一款轻量级但功能完整的个人应用，通过简单的技术栈实现了丰富的功能。项目采用前后端分离架构，使用Flask作为后端框架，SQLite作为数据库，提供了事件记录、照片管理、个性化配置等核心功能。

未来可以考虑以下方向进行扩展：

1. 增加用户认证和数据加密功能，提高安全性
2. 实现云同步功能，支持多设备访问
3. 添加更丰富的数据分析功能，如恋爱统计和纪念提醒
4. 引入机器学习技术，提供更智能的照片管理和推荐功能
5. 支持更多数据格式导入导出，增强应用的兼容性

通过持续优化和功能扩展，该应用有潜力发展成为一款更全面、更智能的恋爱关系记录和管理工具。